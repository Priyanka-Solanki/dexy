#!/usr/bin/env python
import sys
import os
import simplejson as json

project_base = os.path.abspath(os.curdir)
os.chdir(project_base)

if not os.path.exists(sys.argv[1]):
    raise Exception("file %s not found!" % sys.argv[1])

if not os.path.exists('artifacts'):
    raise Exception(
        """artifacts directory not found in %s,
        please create an artifacts directory if you want to use
        this location as a dexy project root""" % project_base
    )

if not os.path.exists('logs'):
    raise Exception(
        """logs directory not found in %s,
        please create a logs directory if you want to use
        this location as a dexy project root""" % project_base
    )

from dexy.controller import Controller
from dexy.logger import log

recurse = True

if recurse:
    for root, dirs, files in os.walk(sys.argv[1]):
        if root.endswith("cache"):
            log.warn("skipping cache dir")
            continue
        log.info("processing dir %s" % root)
        controller = Controller()
        for doc in controller.setup_and_run(root):
            artifact = doc.artifacts[-1]
            artifact.write_cache_output_file()
else:
    controller = Controller()
    for doc in controller.setup_and_run(sys.argv[1]):
        artifact = doc.artifacts[-1]
        artifact.write_cache_output_file()
